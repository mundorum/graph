(function(l,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("/lib/foundation/oidlib-dev.js")):typeof define=="function"&&define.amd?define(["exports","/lib/foundation/oidlib-dev.js"],o):(l=typeof globalThis<"u"?globalThis:l||self,o(l["oid-graph"]={},l.oidlib))})(this,function(l,o){"use strict";class f{_showContextMenu(t){t.preventDefault(),this._node.menu&&DCCContextMenu.display(t.clientX,t.clientY,this._node.menu)}}class d extends f{constructor(t){if(super(),this._node={},Object.assign(this._node,t),t.width==null&&(this._node.width=t.label&&t.label.length*10+20>d.standardDimensions.width?t.label.length*10+20:d.standardDimensions.width),this._nodeClicked=this._nodeClicked.bind(this),this._nodeUnselect=this._nodeUnselect.bind(this),this._showContextMenu=this._showContextMenu.bind(this),this._bus=o.Bus.i,this._presentation=document.createElementNS("http://www.w3.org/2000/svg","g"),this._rect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._rect.setAttribute("rx",10),this._setDimensions(this._rect),this._rect.classList.add("node"),t.format!=null&&this._rect.classList.add(`node-${t.format}`),this._presentation.appendChild(this._rect),t.label!=null){this._contentSpace=document.createElementNS("http://www.w3.org/2000/svg","foreignObject"),this._setDimensions(this._contentSpace),this._label=document.createElement("div"),this._label.style=`width:${this._node.width}px;height:${this._node.height}px`;const e=t.format!=null?` node-primary-${t.format}`:"";this._label.innerHTML=`<div class="node-title node-primary${e}">${t.label}</div>`,this._contentSpace.appendChild(this._label),this._presentation.appendChild(this._contentSpace)}this._cover=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._cover.setAttribute("rx",10),this._setDimensions(this._cover),this._cover.classList.add("node-cover"),this._presentation.appendChild(this._cover),this._presentation.addEventListener("contextmenu",this._showContextMenu),this._setPosition()}get id(){return this._node.id}get x(){return this._node.x}set x(t){this._node.x=t,this._setPosition()}get y(){return this._node.y}set y(t){this._node.y=t,this._setPosition()}get width(){return this._node.width}set width(t){this._graphAttr("width",t)}get height(){return this._node.height}set height(t){this._graphAttr("height",t)}get action(){return this._action}set action(t){this._action=t,this._presentation.style.cursor="pointer",this._presentation.addEventListener("click",this._nodeClicked)}get bus(){return this._bus}set bus(t){this._bus=t}get graph(){return this._graph}set graph(t){this._graph!=null?this._presentation.removeChild(this._graph.presentation):(this._label.classList.remove("dcc-node-label-theme"),this._label.classList.add("dcc-node-label-group-theme")),this._graph=t,this._presentation.appendChild(this._graph.presentation)}get graphWidth(){return this._node.width}set graphWidth(t){this._graphAttr("width",t)}get graphHeight(){return this._node.height}set graphHeight(t){this._graphAttr("height",t)}get presentation(){return this._presentation}_graphAttr(t,e){this._node[t]=e,this._rect.setAttribute(t,e),this._cover.setAttribute(t,e),this._contentSpace!=null&&(this._contentSpace.setAttribute(t,e),this._label.style="width:"+this._node.width+"px;height:"+(this._graph?GraphLayoutDG.parameters["node-label-height"]:this._node.height)+"px")}_setPosition(){this._presentation.setAttribute("transform","translate("+(this.x!=null?this.x:d.standardDimensions.x)+" "+(this.y!=null?this.y:d.standardDimensions.y)+")")}_setDimensions(t){t.setAttribute("width",this.width!=null?this.width:d.standardDimensions.width),t.setAttribute("height",this.height!=null?this.height:d.standardDimensions.height)}addPiece(t,e){this._graph!=null&&this._graph.addPiece(t,e)}_nodeClicked(t){t.stopPropagation(),DCCContextMenu.close(),this._bus.publish("graph/select/clear"),this._cover.classList.remove("dcc-node-cover-theme"),this._cover.classList.add("dcc-node-selected-theme"),this._bus.subscribe("graph/select/clear",this._nodeUnselect),this._bus.publish(this._action,this.id,!0)}_nodeUnselect(){this._bus.unsubscribe("graph/select/clear",this._nodeUnselect),this._cover.classList.remove("dcc-node-selected-theme"),this._cover.classList.add("dcc-node-cover-theme")}_nodeContext(t){}}d.standardDimensions={x:0,y:0,width:100,height:50};class _ extends f{static create(t,e){let s=null;switch(e._layout.label!=null?e._layout.label:"dg"){case"dg":s=new _(t,e);break;case"vh":s=new A(t,e)}return s}constructor(t,e){if(super(),this._edge={},e!=null&&t.source&&t.target){const s=e.nodes.findIndex(h=>h.id===t.source);if(s>-1){let h=-1;switch(t.target){case"#previous":s>0&&(h=s-1);break;case"#next":s<e.nodes.length-1&&(h=s+1);break;default:{let i=t.target;do h=e.nodes.findIndex(a=>a.id===i),h===-1&&i.includes(".")?i=i.substring(0,i.lastIndexOf(".")):i=null;while(i!=null);break}}h>-1&&(t.source=e.nodes[s],t.target=e.nodes[h],Object.assign(this._edge,t),this._presentation=document.createElementNS("http://www.w3.org/2000/svg","g"),this._line=document.createElementNS("http://www.w3.org/2000/svg","polyline"),this._line.setAttribute("fill","none"),this._line.classList.add("edge"),this._presentation.appendChild(this._line),t.label!=null&&(this._labelText=document.createTextNode(t.label),this._label=document.createElementNS("http://www.w3.org/2000/svg","text"),this._label.appendChild(this._labelText),this._presentation.appendChild(this._label)),this.update())}}}get source(){return this._edge.source}get target(){return this._edge.target}get presentation(){return this._presentation}update(){if(this._edge.source!=null&&this._edge.target!=null){const t=this._edge.source,e=this._edge.target,s=t.x+t.width/2,h=t.y+t.height,i=e.x+e.width/2,a=e.y;a>h&&(this._line.setAttribute("points",`${s},${h} ${i},${a}`),this._label!=null&&(this._label.setAttribute("x",(s+i)/2),this._label.setAttribute("y",(h+a)/2),this._labelText.nodeValue=this._edge.label))}}}class A extends _{update(){if(this._edge.source!=null&&this._edge.target!=null){const t=this._edge.source,e=this._edge.target,s=t.x+(e.x-t.x)/2,h=t.y+t.height,i=e.x,a=e.y+e.height/2;this._line.setAttribute("points",`${s},${h} ${s},${a} ${i},${a}`),this._label!=null&&(this._label.setAttribute("x",(s+i)/2),this._label.setAttribute("y",(h+a)/2),this._labelText.nodeValue=this._edge.label)}}}class p{static create(t){let e=null;switch(t??"dg"){case"dg":e=new y;break;case"vh":e=new g}return e}attach(t){this._graph=t}}p.parameters={subgraphs:"vertical","node-width":75,"node-height":42,"node-label-height":30,"node-horizontal-spacing":10,"node-vertical-spacing":30,"horizontal-margin":10,"vertical-margin":10};let y=class u extends p{get label(){return"dg"}organize(){const t={subgraphs:u.parameters.subgraphs,width:u.parameters["node-width"],height:u.parameters["node-height"],hmargin:u.parameters["horizontal-margin"],vmargin:u.parameters["vertical-margin"],hspace:u.parameters["node-horizontal-spacing"],vspace:u.parameters["node-vertical-spacing"]};for(const n of this._graph.nodes)n.level=-1;let e=this._graph.nodes[0],s=0,h=this._graph.labelHeight,i=0,a=0;do{const n=this._visit(e,0,s,h,t);t.subgraphs==="horizontal"?(s+=n.horizontal,i=s,h=0,a=a<n.vertical?n.vertical:a):(s=0,i=i<n.horizontal?n.horizontal:i,h+=n.vertical,a=h),e=this._graph.nodes.find(c=>c.level===-1)}while(e!=null);const r=this._graph._container;this._graph.width=r!=null&&r.label&&r.width&&r.width>i+t.hmargin?r.width:i+t.hmargin,this._graph.height=a+t.vmargin;for(const n of this._graph.edges)n.update()}_visit(t,e,s,h,i){t.level=e,t.width==null&&(t.width=i.width),t.height==null&&(t.height=i.height);const a=this._graph.edges.filter(b=>b.source===t);let r=t.width+i.hspace;const n=t.height+i.vspace;let c=0,w=0;if(a.length>0){for(const b of a)if(b.target!==b.source&&b.target.level===-1){const x=this._visit(b.target,e+1,s+c,h+n,i);c+=x.horizontal,w=w<x.vertical?x.vertical:w}}return t.x=i.hmargin+s,r<c&&(t.x+=(c-r)/2,r=c),t.y=i.vmargin+h,{horizontal:r,vertical:n+w}}};y.parameters=p.parameters;class g extends p{get label(){return"vh"}organize(){const t={width:g.parameters["node-width"],height:g.parameters["node-height"],hmargin:g.parameters["horizontal-margin"],vmargin:g.parameters["vertical-margin"],hspace:g.parameters["node-horizontal-spacing"],vspace:g.parameters["node-vertical-spacing"]};for(const n of this._graph.nodes)n.level=-1;let e=this._graph.nodes[0],s=t.hmargin,h=this._graph.labelHeight,i=0,a=0;do{const n=this._visit(e,0,s,h,t);s=t.hmargin,i=i<n.horizontal?n.horizontal:i,h+=n.vertical,a=h,e=this._graph.nodes.find(c=>c.level===-1)}while(e!=null);const r=this._graph._container;this._graph.width=r!=null&&r.label&&r.width&&r.width>i+t.hmargin?r.width:i+t.hmargin,this._graph.height=a+t.vmargin;for(const n of this._graph.edges)n.update()}_visit(t,e,s,h,i){t.level=e,t.width==null&&(t.width=i.width),t.height==null&&(t.height=i.height),t.x=s,t.y=h;const a=this._graph.edges.filter(n=>n.source===t);let r=t.height+i.vspace;if(a.length>0){for(const n of a)if(n.target!==n.source&&n.target.level===-1){const c=this._visit(n.target,e+1,s+i.hspace,h+r,i);r+=c.vertical}}return{horizontal:s+t.width+i.hspace,vertical:r}}}g.parameters=Object.assign(Object.assign({},p.parameters),{"node-horizontal-spacing":20,"node-vertical-spacing":10});class m{constructor(t,e,s,h,i){this._container=t,this._label=e,this._action=h,this._bus=i,this.clearGraph(),this._presentation=document.createElementNS("http://www.w3.org/2000/svg","g"),this._layout=p.create(s),this._layout.attach(this)}get label(){return this._label}set label(t){this._label=t}get width(){return this._container.graphWidth}set width(t){this._container.graphWidth=t}get height(){return this._container.graphHeight}set height(t){this._container.graphHeight=t}get nodes(){return this._nodes}get edges(){return this._edges}get action(){return this._action}set action(t){this._action=action}addPiece(t,e){this[`_${t}s`].push(e),e.presentation!=null&&(this._presentation.appendChild(e.presentation),this._action&&t==="node"&&(e.action=this._action,e.bus=this._bus)),this._layout!=null&&this._layout.organize()}clearGraph(){if(this._nodes)for(let t of this._nodes)t.presentation!=null&&this._presentation.removeChild(t.presentation);if(this._edges)for(let t of this._edges)t.presentation!=null&&this._presentation.removeChild(t.presentation);this._nodes=[],this._edges=[]}importGraph(t){for(const e of t.nodes){const s=new d(e);e.graph&&(s.graph=new m(s,e.label,this._layout.label,this._action,this._bus),s.graph.importGraph(e.graph)),this.addPiece("node",s)}for(const e of t.edges)this.addPiece("edge",_.create(e,this))}get presentation(){return this._presentation}get labelHeight(){return this._label!=null?p.parameters["node-label-height"]:0}}class C extends o.OidUI{async connectedCallback(){await super.connectedCallback(),this._graph=new m(this,this.label,this.layout,this.action,this._bus),this._graphObj?(this._graph.importGraph(this._graphObj),this._graphObj=void 0):this._callCustom("graph"),this._presentation.appendChild(this._graph.presentation)}get graph(){return this._graph}get graphWidth(){return this._presentation.getAttribute("width")}set graphWidth(t){this._presentation.setAttribute("width",t)}get graphHeight(){return this._presentation.getAttribute("height")}set graphHeight(t){this._presentation.setAttribute("height",t)}addPiece(t,e){this._graph.addPiece(t,e)}importGraph(t){this._graph!=null?this._graph.importGraph(t):this._graphObj=t}handleAddNode(t,e){this._graph.addPiece("node",new d(e))}handleAddEdge(t,e){this._graph.addPiece("edge",_.create(e,this._graph))}handleClearGraph(){this._graph.clearGraph()}}o.Oid.component({id:"goid:graph",element:"graph-oid",properties:{label:{default:"Graph"},width:{default:300},height:{default:200},layout:{},action:{}},receive:{"node/add":"handleAddNode","edge/add":"handleAddEdge","graph/clear":"handleClearGraph"},implementation:C,stylesheets:"stylesheets:oid-graph.css",template:o.html`
  <div id="graph-wrapper">
    <svg id="oid-prs" width="{{this.width}}" height="{{this.height}}" xmlns="http://www.w3.org/2000/svg">
    </svg>
  </div>`}),Object.defineProperty(l,"Bus",{enumerable:!0,get:()=>o.Bus}),Object.defineProperty(l,"Oid",{enumerable:!0,get:()=>o.Oid}),Object.defineProperty(l,"Sphere",{enumerable:!0,get:()=>o.Sphere}),Object.defineProperty(l,"css",{enumerable:!0,get:()=>o.css}),l.Graph=m,l.GraphEdge=_,l.GraphLayout=p,l.GraphNode=d,l.GraphOid=C,l.GraphPiece=f,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
